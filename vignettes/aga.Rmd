---
title: "AGA"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r eval=FALSE, include=FALSE}
file <- "aga"
rmarkdown::render(glue::glue("vignettes/{file}.Rmd"), output_dir = "inst/doc/")
readr::read_lines(glue::glue("inst/doc/{file}.md")) %>% stringr::str_replace_all(paste0(rprojroot::find_rstudio_root_file(), "/inst/doc/"), "") %>% readr::write_lines(glue::glue("inst/doc/{file}.md"))
```

This document serves to provide insight into how a trajectory inference method was used and wrapped. 
Feel free to discuss implementation-specific details by [creating an issue](https://github.com/dynverse/dynmethods/issues) on GitHub,
or improve the wrapper and create a pull request.


```{r}
library(tidyverse)
library(dynmethods)
library(dynwrap)
library(dynutils)
library(dynplot)
```

# Description
AGA is a trajectory inference method implemented in the [Scanpy](https://scanpy.readthedocs.io/en/latest/) package.
The core algorithms used are k-nearest-neighbours for representing cells as a graph, louvain clustering for grouping 
cells into milestones, and connectivity testing for identifying transitions between the milestones.
The wrapper can be accessed using the `ti_aga` function.
```{r}
method <- ti_aga()
```

This description contains information on which packages need to have been installed in order to run 
the method and what are the parameters.

```{r}
str(method, max.level = 1)
method$par_set
```

# Example
First we retrieve a toy dataset from [http://github.com/dynverse/dyntoy](dyntoy).
```{r}
toy_tasks <- dyntoy::toy_tasks %>% 
  filter(model == "consecutive_bifurcating") %>% 
  slice(1)
toy_task <- toy_tasks %>% extract_row_to_list(1)

plot_default(toy_task)
```

We extract the default parameters from the method.
```{r}
defprm <- get_default_parameters(method)
```

Applying AGA on the toy dataset can be performed using the `infer_trajectory` function.
```{r}
out <- infer_trajectory(toy_tasks, method, parameters = defprm)[[1]]
```

The output will consist of a summary and the model. The summary will contain information 
pertaining the execution of the method, while the model will contain the trajectory inferred
by the method.

```{r}
out$summary %>% knitr::kable()

model <- out$model 

plot_default(model)
plot_trajectory(model, method)
```

# Wrapper implementation
This section will detail the specific wrapper implementation by applying it on the toy dataset, 
and should follow the same implementation structure as the [https://github.com/dynverse/dynmethods/blob/master/R/ti_aga.R](source code).

Since AGA is implemented in Python, we created an R package for it, available at [github.com/dynverse/aga](https://github.com/dynverse/aga).
The R package will write the expression values and any parameters to a file, execute a python script, and read the results from output files produced by AGA.
```{r}
expression <- toy_task$expression
aga_out <- aga::aga(
  expression = expression,
  start_cell = NULL,
  grouping_assignment = NULL,
  n_neighbours = defprm$n_neighbours,
  n_pcs = defprm$n_pcs,
  n_dcs = defprm$n_dcs,
  resolution = defprm$resolution,
  tree_based_confidence = defprm$tree_based_confidence,
  verbose = FALSE,
  num_cores = 1
)
aga_out$obs <- aga_out$obs %>% mutate(group_id = paste0("B", group_id))
aga_out$adj <- aga_out$adj %>% mutate(from = paste0("B", from), to = paste0("B", to))

milestone_ids <- unique(c(aga_out$adj$from, aga_out$adj$to, aga_out$obs$group_id))
```

After building a kNN graph, the kNN graph is clustered into louvain groups:
```{r}
aga_out$obs %>% head(6) %>% knitr::kable()

grouping <- setNames(aga_out$obs$group_id, aga_out$obs$cell_id)
```

Several tests are used to assess which transitions exist between the louvain groups. 
We use the `aga_adjacency_tree_confidence` to construct the milestone network.
```{r}
aga_out$adj %>% head(6) %>% knitr::kable()

milestone_network <- aga_out$adj %>%
  mutate_at(vars(from, to), as.character) %>%
  filter(aga_adjacency_tree_confidence > 0) %>%
  mutate(
    length = 1,
    directed = FALSE
  ) %>%
  select(from, to, length, directed)
```

The prediction is wrapped using the `add_cluster_graph` function. 
```{r}
prediction <- wrap_prediction_model(
  cell_ids = rownames(expression)
) %>% add_grouping(
  group_ids = milestone_ids,
  grouping = grouping
) %>% add_cluster_graph(
  milestone_network = milestone_network,
  aga_out = aga_out
)

plot_default(prediction)
plot_trajectory(model, method)
```

# Quality control
TODO

# To do's
 * Allow the aga R package to return the dimensionality reductions created by scanpy.
